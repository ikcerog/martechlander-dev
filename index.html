<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEV üì£ AdTech News</title>
   
    <style>
        /* --- CSS Styling and Variables --- */
        :root {
            /* Light Theme Defaults */
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --secondary-accent-1: #2ecc71;  
            --secondary-accent-2: #e67e22;  
            --secondary-accent-3: #16a085;  
            --secondary-accent-4: #f39c12;  
            --background-color: #ecf0f1;
            --card-background: #ffffff;
            --text-color: #34495e;
            --secondary-text-color: #7f8c8d;
            --border-color: #bdc3c7;
            --hide-color: #e74c3c;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #9b59b6;
            --accent-color: #3498db;
            --secondary-accent-1: #1abc9c;
            --secondary-accent-2: #d35400;
            --secondary-accent-3: #1abc9c;
            --secondary-accent-4: #e67e22;
            --background-color: #2c3e50;
            --card-background: #34495e;
            --text-color: #ecf0f1;
            --secondary-text-color: #bdc3c7;
            --border-color: #49627a;
            --hide-color: #c0392b;
        }

        /* Midnight Mode Variables */
        body.midnight-mode {
            --primary-color: #0d1a26;
            --accent-color: #5d9cec;
            --secondary-accent-1: #48c9b0;  
            --secondary-accent-2: #f5b041;  
            --secondary-accent-3: #45b39d;  
            --secondary-accent-4: #f7dc6f;  
            --background-color: #010409;
            --card-background: #0d1117;
            --text-color: #c9d1d9;
            --secondary-text-color: #8b949e;
            --border-color: #30363d;
            --hide-color: #ff7b72;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header Styling */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
       
        /* Header Max-Width Container */
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 1.8em; }

        /* Search Input */
        #search-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
        }

        /* Control Buttons Container */
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
       
        /* Filter Bar Container */
        #filter-bar-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 200px; /* Max height when visible */
            padding-top: 10px;
        }
       
        #filter-bar-container.hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }
       
        /* Theme, View, and Filter Buttons */
        .control-button {
            padding: 8px 15px;
            border: 1px solid white;
            background-color: transparent;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
        }

        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
       
        /* Highlight active filter button */
        .control-button.active {
            background-color: white;
            color: var(--primary-color);
            border-color: white;
        }
       
        body.dark-mode .control-button.active, body.midnight-mode .control-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

       
        /* View Toggle Specific Styling */
        #view-toggle-row {
            display: flex;
            gap: 5px;
            border-right: 1px solid rgba(255, 255, 255, 0.5);
            padding-right: 15px;
            margin-right: 5px;
        }
        .view-button.active {
            background-color: white;
            color: var(--primary-color);
        }
        body.dark-mode .view-button.active, body.midnight-mode .view-button.active {
            background-color: var(--text-color);
            color: var(--primary-color);
        }

       
        #reset-hidden-button {
            background-color: var(--hide-color);
            border-color: var(--hide-color);
        }
        #reset-hidden-button:hover {
            opacity: 0.8;
        }

        /* Feed Sections */
        .feed-section {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
            overflow: hidden;
        }
       
        .feed-section.hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        .feed-section h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.5em;
        }

        body.dark-mode .feed-section h2, body.midnight-mode .feed-section h2 {
            border-bottom-color: var(--accent-color);
            color: var(--text-color);
        }
       
        /* Specific header colors for flair */
        #community-pulse-feed h2 { color: var(--secondary-accent-1); }
        #branding-advertising-feed h2 { color: var(--secondary-accent-2); }
        /* FinTech (Enterprise Tech) and Tech Culture */
        #fintech-new-feed h2 { color: var(--secondary-accent-3); }
        #tech-culture-feed h2 { color: var(--secondary-accent-3); }
        #ad-tech-feed h2 { color: var(--secondary-accent-4); }


        /* --- VIEW CONTROLS CSS (Grid and List) --- */
       
        /* Default: GRID VIEW (Multi-Column) */
        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
       
        .news-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* LIST VIEW: Overrides Grid */
        body.list-view .feed-section:not(#community-pulse-feed) .news-grid {
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card {
            flex-direction: row;
            align-items: center;
            padding: 15px 20px;
            width: auto; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card h4 {
            flex-basis: 50%;
            margin: 0;
            font-size: 1.1em;
            order: 1;
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .description,
        /* Hide the default card controls in List View */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card > .card-controls.grid-controls {
            display: none; 
        }
       
        /* Target the combined date and control container in List View */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .date-and-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            gap: 20px;
            flex-grow: 1; 
            order: 2;
        }

        /* Adjustments for elements inside the new container */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .date {
            border-top: none;
            padding-top: 0;
            margin: 0;
            font-size: 0.9em;
            flex-shrink: 0; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .card-controls.list-controls {
            /* This is the inner .card-controls inside .date-and-controls */
            display: flex !important; /* Override display:none from above */
            flex-basis: auto;
            justify-content: flex-end;
            margin: 0;
            flex-shrink: 0; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .card-controls.list-controls span {
            display: none; 
        }
        /* --- END VIEW CONTROLS CSS --- */


        .reddit-subsection {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
        }
        .reddit-subsection h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: var(--accent-color);
        }


        .news-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
       
        .news-card.hidden-tile, .news-card.auto-filtered {
            display: none !important;
        }

        .news-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
       
        /* Grid View Controls (Default for .card-controls) */
        .card-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;  
        }
       
        .card-controls span {
            font-size: 0.7em;
            color: var(--secondary-text-color);
            opacity: 0.8;
        }
       
        .card-controls button {
            background: none;
            border: none;
            color: var(--hide-color);
            font-size: 0.8em;
            cursor: pointer;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
       
        .card-controls button:hover {
            opacity: 1;
        }
       
        /* List View control needs to be explicitly shown/hidden */
        .card-controls.list-controls {
            display: none; /* Hidden by default, shown in list-view mode */
        }


        .news-card h4 { margin: 0 0 10px 0; font-size: 1.15em; line-height: 1.4; }
        .news-card h4 a { color: var(--accent-color); text-decoration: none; transition: color 0.2s; }
        body.dark-mode .news-card h4 a:hover, body.midnight-mode .news-card h4 a:hover { color: var(--text-color); }

        .news-card .description {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            line-height: 1.5;
            margin-top: 0;
            flex-grow: 1;  
        }
       
        /* AI Summary Panel Specific Styling */
        #ai-insight-panel {
            background-color: var(--card-background);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            padding: 20px; /* Add padding for a better look */
        }
        
        #ai-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #ai-summary-header h2 {
            margin: 0;
            font-size: 1.5em;
            border-bottom: none;
            padding-bottom: 0;
        }
        
        /* New styling for the status/throttle message container */
        #ai-summary-status {
            padding: 10px 0 0 0;
            margin-bottom: 10px;
            line-height: 1.5;
            white-space: pre-wrap;
            border-bottom: 1px dashed var(--border-color);
        }

        #ai-summary-content {
            padding: 10px 0 0 0; /* Adjusted padding */
            line-height: 1.6;
            white-space: pre-wrap; /* Ensures the AI's formatting (like newlines) is respected */
            margin-top: 10px;
        }
        
        #copy-summary-button {
            padding: 5px 10px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #copy-summary-button:hover {
            opacity: 0.9;
            background-color: var(--primary-color);
        }
    </style>
</head>
<body class="light-mode">
    <header>
        <div class="header-content">
            <div class="header-top">
                <h1>üöß DEV üì£ AdTech News</h1>
                <button id="theme-toggle" class="control-button" onclick="toggleTheme()">‚òÄÔ∏è Switch to Dark Mode</button>
            </div>
           
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Start searching across all feeds..." onkeyup="filterCards()">
            </div>
           
            <div class="controls-row">
                <button id="toggle-filter-bar-btn" class="control-button" onclick="toggleFilterBar()">Hide Filter Bar</button>

                <div id="view-toggle-row">
                    <button id="grid-view-button" class="view-button control-button" onclick="setListView('grid')">Grid View</button>
                    <button id="list-view-button" class="view-button control-button" onclick="setListView('list')">List View</button>
                </div>
               
                <button id="reset-hidden-button" class="control-button" onclick="resetHiddenTiles()">Reset Hidden Tiles</button>
            </div>
           
            <div id="filter-bar-container">
                <button id="toggle-core-marketing" class="control-button active" data-target="core-marketing-feed" onclick="toggleSection(this)">Core Marketing</button>
                <button id="toggle-branding" class="control-button active" data-target="branding-advertising-feed" onclick="toggleSection(this)">Branding & Campaigns</button>
                <button id="toggle-adtech" class="control-button active" data-target="ad-tech-feed" onclick="toggleSection(this)">Ad Technology</button>
                <button id="toggle-fintech" class="control-button active" data-target="fintech-new-feed" onclick="toggleSection(this)">Enterprise Tech</button>
                <button id="toggle-tech" class="control-button active" data-target="tech-culture-feed" onclick="toggleSection(this)">Tech & Culture</button>
                <button id="toggle-community" class="control-button active" data-target="community-pulse-feed" onclick="toggleSection(this)">Community Pulse</button>
            </div>
        </div>
    </header>

    <details open="open" style="margin: 8px auto; max-width: 1400px; padding: 16px; box-shadow: 0 0 4px #33333333; border-radius: 8px;"><summary>Click to Hide/Show AI Summary</summary>
    <div id="ai-insight-panel" class="feed-section">
        <div id="ai-summary-header">
             <h2>‚ú® AI Strategy Summary</h2>
             <button id="generate-summary-button" onclick="generateAISummary()" title="Generate AI summary (costs API credits)">Generate Summary</button>
             <button id="copy-summary-button" onclick="copyAISummary()" title="Copy the full AI Summary to your clipboard" disabled>Copy Summary</button>
        </div>
        
        <div id="ai-summary-status">
            </div>
        
        <div id="ai-summary-content">
            <p>AI summary is slowed in DEV to preserve resources</p>
        </div>
    </div>
    </details>

    <div id="core-marketing-feed" class="feed-section">
        <h2>üìà Core Marketing (Marketing Dive)</h2>
        <div class="news-grid-container" data-feed-id="core-marketing-feed">
            <div class="news-grid">Loading Core Marketing...</div>
        </div>
    </div>

    <div id="branding-advertising-feed" class="feed-section">
        <h2>‚≠êÔ∏è Branding & Campaigns (Adweek, AdPulp, More...)</h2>
        <div class="news-grid-container" data-feed-id="branding-advertising-feed">
            <div class="news-grid">Loading Branding & Campaigns...</div>
        </div>
    </div>

    <div id="ad-tech-feed" class="feed-section">
        <h2>‚öôÔ∏è Ad Technology (AdExchanger, VideoWeek...)</h2>
        <div class="news-grid-container" data-feed-id="ad-tech-feed">
            <div class="news-grid">Loading Ad Technology...</div>
        </div>
    </div>

    <div id="fintech-new-feed" class="feed-section">
        <h2>üí∞ Enterprise Tech & FinTech (CIO Dive, Banking Dive)</h2>
        <div class="news-grid-container" data-feed-id="fintech-new-feed">
            <div class="news-grid">Loading Enterprise Tech & FinTech...</div>
        </div>
    </div>

    <div id="tech-culture-feed" class="feed-section">
        <h2>üåê Tech & Culture (Wired)</h2>
        <div class="news-grid-container" data-feed-id="tech-culture-feed">
            <div class="news-grid">Loading Tech & Culture...</div>
        </div>
    </div>
   
    <div id="community-pulse-feed" class="feed-section">
        <h2>üó£Ô∏è Community Pulse (Reddit Subreddits)</h2>
        <div id="community-pulse-container">
        </div>
    </div>
   
    <script>
        /* --- JavaScript for Theme Switching, Fetching, Rendering, and Controls --- */

        // --- BLACKLIST KEYWORDS ---
        const BLACKLIST_KEYWORDS = [
            "coupon code:",
            "promo code:",
            "discount offer:",
            "save now",
            "limited time deal",
            "free trial",
            "get 50%"
        ];

        const EDITORIAL_FEEDS = [
            // --- CORE MARKETING ---
            { id: 'core-marketing-feed', url: 'https://www.marketingdive.com/feeds/news', source: 'Marketing Dive' },
            { id: 'core-marketing-feed', url: 'https://www.campaignlive.co.uk/rss/latest', source: 'Campaign Live' }, // ADDED: Campaign Dive
           
            // --- BRANDING & CAMPAIGNS ---
            { id: 'branding-advertising-feed', url: 'https://www.adweek.com/feed/', source: 'Adweek' }, 
            { id: 'branding-advertising-feed', url: 'https://www.moreaboutadvertising.com/feed/', source: 'More About Adv.' },
            { id: 'branding-advertising-feed', url: 'https://feeds.feedburner.com/Adpulp', source: 'AdPulp' },
           
            // --- EXPANDED AD TECH FEEDS ---
            { id: 'ad-tech-feed', url: 'https://www.adexchanger.com/feed/', source: 'AdExchanger' },
            { id: 'ad-tech-feed', url: 'https://adtechdaily.com/feed/', source: 'Ad Tech Daily' },
            { id: 'ad-tech-feed', url: 'https://videoweek.com/feed/', source: 'VideoWeek' },
            { id: 'ad-tech-feed', url: 'https://advertisemint.com/feed/', source: 'AdvertiseMint' },
            { id: 'ad-tech-feed', url: 'https://medium.com/feed/ipg-media-lab', source: 'IPG Media Lab' }, // Programmatic / Innovation
            { id: 'ad-tech-feed', url: 'https://silverpush.co/feed', source: 'SilverPush Blog' }, // Video/AI AdTech
           
            // --- ENTERPRISE & FINTECH SECTION ---
            { id: 'fintech-new-feed', url: 'https://www.ciodive.com/feeds/news/', source: 'CIO Dive' },
            { id: 'fintech-new-feed', url: 'https://www.bankingdive.com/feeds/news/', source: 'Banking Dive' },
           
            // --- TECH & CULTURE ---
            { id: 'tech-culture-feed', url: 'https://www.wired.com/feed/rss', source: 'Wired' }, 
            { id: 'tech-culture-feed', url: 'https://www.fastcompany.com/rss', source: 'Fast Company' }, // ADDED: Fast Company
        ];
       
        const REDDIT_FEEDS = [
            { id: 'r/marketing', url: 'https://www.reddit.com/r/marketing.rss' },
            { id: 'r/advertising', url: 'https://www.reddit.com/r/advertising.rss' },
            { id: 'r/tech', url: 'https://www.reddit.com/r/tech.rss' },
            { id: 'r/fintech', url: 'https://www.reddit.com/r/Fintech.rss' },
            { id: 'r/userexperience', url: 'https://www.reddit.com/r/userexperience.rss' },
        ];
       
        const RSS_TO_JSON_PROXY_BASE = 'https://api.rss2json.com/v1/api.json?rss_url=';
        let HIDDEN_LINKS = new Set();
       
        // --- THEME LOGIC (Triple Mode) ---
        const THEMES = ['light-mode', 'dark-mode', 'midnight-mode'];
        const THEME_LABELS = {
            'light-mode': '‚òÄÔ∏è Switch to Dark Mode',
            'dark-mode': 'üåô Switch to Midnight Mode',
            'midnight-mode': 'üåå Switch to Light Mode'
        };

        function toggleTheme() {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            
            // Get current theme from body class (or default)
            let currentTheme = THEMES.find(t => body.classList.contains(t)) || 'light-mode';
            
            const currentIndex = THEMES.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % THEMES.length;
            const newTheme = THEMES[nextIndex];

            // Remove all existing theme classes and add the new one
            body.classList.remove(...THEMES);
            body.classList.add(newTheme);
            
            localStorage.setItem('theme', newTheme);
            // Set the button text to prompt the switch to the *next* theme (which is the current theme's label)
            toggleButton.textContent = THEME_LABELS[newTheme];
        }

        function loadThemePreference() {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            
            // Apply the saved theme and set the correct button label
            body.classList.remove(...THEMES);
            body.classList.add(savedTheme);
            
            // Set the button text to prompt the switch to the *next* theme
            toggleButton.textContent = THEME_LABELS[savedTheme];
        }
       
        // --- UPDATED: CLICK TO COPY LOGIC (Excludes Header/Status) ---
        window.copyAISummary = async function() {
            // CRITICAL CHANGE: Only target the clean content div, not the status header
            const summaryDiv = document.getElementById('ai-summary-content'); 
            const copyButton = document.getElementById('copy-summary-button');
            const originalText = copyButton.textContent;
            
            // Use innerText to grab the readable, rendered content
            const textToCopy = summaryDiv.innerText;

            try {
                await navigator.clipboard.writeText(textToCopy);
                copyButton.textContent = '‚úÖ Copied!';
                copyButton.style.backgroundColor = 'var(--secondary-accent-1)';
                copyButton.style.borderColor = 'var(--secondary-accent-1)';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copyButton.textContent = '‚ùå Failed!';
                copyButton.style.backgroundColor = 'var(--hide-color)';
                copyButton.style.borderColor = 'var(--hide-color)';
            }

            // Revert button text and color after a short delay
            setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.style.backgroundColor = 'var(--accent-color)';
                copyButton.style.borderColor = 'var(--accent-color)';
            }, 2000);
        }

        // Helper to enable the copy button once the summary is loaded
        function enableCopyButton() {
             const copyButton = document.getElementById('copy-summary-button');
             copyButton.disabled = false;
             copyButton.textContent = 'Copy Summary';
        }
        // --- END CLICK TO COPY LOGIC ---


        // --- VIEW TOGGLE LOGIC ---
       
        window.setListView = function(view) {
            const body = document.body;
            const gridButton = document.getElementById('grid-view-button');
            const listButton = document.getElementById('list-view-button');

            if (view === 'list') {
                body.classList.add('list-view');
                listButton.classList.add('active');
                gridButton.classList.remove('active');
                localStorage.setItem('newsView', 'list');
            } else {
                body.classList.remove('list-view');
                gridButton.classList.add('active');
                listButton.classList.remove('active');
                localStorage.setItem('newsView', 'grid');
            }
        }

        function loadViewPreference() {
            const savedView = localStorage.getItem('newsView') || 'grid';
            setListView(savedView);
        }

        // --- FILTER BAR TOGGLE LOGIC ---
        window.toggleFilterBar = function() {
            const filterBar = document.getElementById('filter-bar-container');
            const toggleButton = document.getElementById('toggle-filter-bar-btn');
           
            const isHidden = filterBar.classList.toggle('hidden');
           
            if (isHidden) {
                toggleButton.textContent = 'Show Filter Bar';
                localStorage.setItem('filterBarHidden', 'true');
            } else {
                toggleButton.textContent = 'Hide Filter Bar';
                localStorage.setItem('filterBarHidden', 'false');
            }
        }
       
        function loadFilterBarPreference() {
            const filterBar = document.getElementById('filter-bar-container');
            const toggleButton = document.getElementById('toggle-filter-bar-btn');
            const isHidden = localStorage.getItem('filterBarHidden') === 'true';
           
            if (isHidden) {
                filterBar.classList.add('hidden');
                toggleButton.textContent = 'Show Filter Bar';
            } else {
                filterBar.classList.remove('hidden');
                toggleButton.textContent = 'Hide Filter Bar';
            }
        }

        // --- PERSISTENCE & UTILITY LOGIC ---
       
        function loadHiddenLinks() {
            const storedLinks = localStorage.getItem('hiddenNewsLinks');
            if (storedLinks) {
                HIDDEN_LINKS = new Set(JSON.parse(storedLinks));
            }
        }
       
        function saveHiddenLinks() {
            localStorage.setItem('hiddenNewsLinks', JSON.stringify(Array.from(HIDDEN_LINKS)));
        }

        window.hideTileForever = function(button, link) {
            const card = button.closest('.news-card');
            if (card && link) {
                card.classList.add('hidden-tile');
                HIDDEN_LINKS.add(link);
                saveHiddenLinks();
            }
        }
       
        window.resetHiddenTiles = function() {
            if (confirm("Are you sure you want to reset all permanently hidden news tiles? This cannot be undone.")) {
                localStorage.removeItem('hiddenNewsLinks');
                HIDDEN_LINKS = new Set();
                location.reload(); 
            }
        }
       
        window.filterCards = function() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const cards = document.querySelectorAll('.news-card:not(.hidden-tile):not(.auto-filtered)');

            cards.forEach(card => {
                const title = card.getAttribute('data-search-title');
                const description = card.getAttribute('data-search-desc');
               
                if (title.includes(filter) || description.includes(filter)) {
                    card.style.display = ''; 
                } else {
                    card.style.display = 'none'; 
                }
            });
        }
       
        window.toggleSection = function(button) {
            const targetId = button.getAttribute('data-target');
            const section = document.getElementById(targetId);

            if (!section) return;

            // Note: The max-height trick works best with a fixed large value
            if (section.classList.contains('hidden')) {
                section.style.maxHeight = '5000px'; 
                section.classList.remove('hidden');
                button.classList.add('active');
            } else {
                section.classList.add('hidden');
                button.classList.remove('active');
            }
        }


        // --- AUTO-LOAD CACHED SUMMARY ON PAGE LOAD ---
        async function loadCachedSummary() {
            const statusDiv = document.getElementById('ai-summary-status');
            const summaryDiv = document.getElementById('ai-summary-content');
            const generateBtn = document.getElementById('generate-summary-button');

            try {
                const response = await fetch('/api/get-cached-summary');
                const data = await response.json();

                if (!data.cached) {
                    // No cache available
                    statusDiv.innerHTML = `<p style="color: #888;">${data.message}</p>`;
                    summaryDiv.innerHTML = '';
                    generateBtn.textContent = '‚ú® Generate Summary';
                    return;
                }

                // Display cached summary
                summaryDiv.innerHTML = data.summary;
                enableCopyButton();

                if (data.isThrottled) {
                    // Show throttle status
                    statusDiv.innerHTML = `
                        <div style="background: var(--card-background); border: 2px solid var(--secondary-accent-2); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <h3 style="margin: 0 0 8px 0; color: var(--secondary-accent-2);">‚è≥ Summary Throttle Active</h3>
                            <p style="margin: 4px 0; color: var(--text-color);">Last generated at <strong>${data.formattedTime}</strong></p>
                            <p style="margin: 4px 0; color: var(--text-color);">Next generation available at <strong>${data.nextRunTime}</strong> (in ${data.minutesRemaining} minutes)</p>
                            <p style="margin: 8px 0 0 0; font-size: 0.9em; color: var(--secondary-text-color);">The AI model was not called to conserve API usage.</p>
                        </div>
                    `;
                    generateBtn.textContent = '‚ö° Force Re-generate (uses API credits)';
                    generateBtn.style.background = '#ff6b6b';
                } else {
                    // Cache exists but throttle expired
                    statusDiv.innerHTML = `
                        <div style="background: var(--card-background); border: 2px solid var(--secondary-accent-1); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <p style="margin: 0; color: var(--text-color);">‚úÖ Last generated at <strong>${data.formattedTime}</strong></p>
                            <p style="margin: 4px 0 0 0; font-size: 0.9em; color: var(--secondary-text-color);">You can generate a fresh summary now.</p>
                        </div>
                    `;
                    generateBtn.textContent = 'üîÑ Re-generate Summary';
                    generateBtn.style.background = '#28a745';
                }

            } catch (error) {
                console.error('Error loading cached summary:', error);
            }
        }

        // --- AI SUMMARY INTEGRATION FUNCTION (Calls Server) ---
        async function generateAISummary(forceRegenerate = false) {
            const statusDiv = document.getElementById('ai-summary-status'); // NEW: For throttle message
            const summaryDiv = document.getElementById('ai-summary-content'); // For clean summary
           
            // SECURITY CHECK: Must be run on http://localhost:3000, not file://
            if (window.location.protocol === 'file:') {
                 statusDiv.innerHTML = ``;
                 summaryDiv.innerHTML = `<p><strong>Note:</strong> To use the AI Strategy Summary, you MUST run this file 
                 via your secure Node.js server (e.g., <code>http://localhost:3000</code>). 
                 The API endpoint is not accessible from a local <code>file://</code> URL.</p>`;
                 document.getElementById('copy-summary-button').disabled = true;
                 return;
            }

            try {
                // Grab the HTML content of the main feeds area.
                const feedsContainer = document.getElementById('core-marketing-feed').parentElement;
                const htmlContent = feedsContainer ? feedsContainer.outerHTML : ''; 

                if (!htmlContent.includes('news-card')) {
                     statusDiv.innerHTML = ``;
                     summaryDiv.innerHTML = `<p>Awaiting news articles to load, then initiating AI analysis...</p>`;
                     return;
                }

                statusDiv.innerHTML = ``;
                summaryDiv.innerHTML = `<p><strong>Generating AI summary and strategic recommendations...</strong></p>`;

                // Call the secure server-side proxy endpoint
                const response = await fetch('/api/summarize-news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ htmlContent: htmlContent, forceRegenerate: forceRegenerate }),
                });

                const data = await response.json();

                if (response.status !== 200 || data.error) {
                    statusDiv.innerHTML = ``;
                    summaryDiv.innerHTML = `<p style="color: var(--hide-color);">Error generating summary. Check Node.js console. (Server Status: ${response.status})</p>`;
                    console.error("AI Proxy Error:", data.error || 'Unknown server error.');
                    document.getElementById('copy-summary-button').disabled = true;
                    return;
                }

                // After generating, reload the cached summary to update UI properly
                await loadCachedSummary();

            } catch (e) {
                statusDiv.innerHTML = ``;
                summaryDiv.innerHTML = `<p style="color: var(--hide-color);">Could not connect to AI server. Ensure <code>node server.js</code> is running on port 3000.</p>`;
                console.error("Frontend Fetch Error:", e);
                document.getElementById('copy-summary-button').disabled = true;
            }
        }
        // --- END AI SUMMARY FUNCTION ---


        // --- FETCH & RENDER LOGIC ---

        async function fetchAndRenderAllFeeds() {
            // Editorial Feeds
            const fetchEditorialPromises = EDITORIAL_FEEDS.map(feed => fetchAndRenderFeed(feed.url, feed.id, feed.source, false));
            // Await the main editorial feeds to ensure content is present for the AI
            await Promise.all(fetchEditorialPromises);

            // Summary generation is now MANUAL - user must click "Generate Summary" button
            // This prevents automatic API calls that cost money on every page load 

            // Reddit Feeds setup (can run in parallel or after summary trigger)
            const communityContainer = document.getElementById('community-pulse-container');
            let communityGridHTML = '';
           
            for (const feed of REDDIT_FEEDS) {
                const subredditId = feed.id.split('/')[1];
                communityGridHTML += `<div class="reddit-subsection">
                                    <h3>r/${subredditId}</h3>
                                    <div class="news-grid" id="${feed.id}-grid">Loading...</div>
                                </div>`;
            }
            communityContainer.innerHTML = communityGridHTML;

            REDDIT_FEEDS.forEach(feed => {
                 fetchAndRenderFeed(feed.url, `${feed.id}-grid`, feed.id, true);
            });
        }


        async function fetchAndRenderFeed(feedUrl, containerId, sourceName, isReddit) {
            const sectionDiv = document.getElementById(containerId);
            const gridContainer = sectionDiv.querySelector('.news-grid') || document.getElementById(containerId);
           
            try {
                const proxyUrl = `${RSS_TO_JSON_PROXY_BASE}${encodeURIComponent(feedUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (data.status !== 'ok' || !data.items) {
                    throw new Error('Failed to fetch feed data or feed is empty.');
                }

                if (gridContainer.textContent.includes('Loading')) {
                    gridContainer.innerHTML = ''; 
                }
               
                data.items.slice(0, 10).forEach(item => {
                    const card = createNewsCard(item, sourceName, isReddit);
                    if (card) { 
                        gridContainer.appendChild(card);
                    }
                });

            } catch (error) {
                console.error(`Error fetching or rendering feed for ${containerId} (${sourceName}):`, error);
                if (gridContainer.textContent.includes('Loading')) {
                    gridContainer.innerHTML = `<p style="color: red; text-align: center; width: 100%;">Error loading feed: ${sourceName}</p>`;
                }
            }
        }
       
        /**
         * Checks if the title or description contains any blacklisted keyword.
         * @param {string} title 
         * @param {string} description 
         * @returns {boolean} True if the item should be automatically filtered.
         */
        function isAutoFiltered(title, description) {
            const content = (title + ' ' + description).toLowerCase();
            return BLACKLIST_KEYWORDS.some(keyword => content.includes(keyword));
        }


        function createNewsCard(item, sourceName, isReddit) {
            if (HIDDEN_LINKS.has(item.link)) {
                return null; 
            }
           
            const card = document.createElement('div');
            card.className = 'news-card';
           
            const title = item.title || 'No Title';
            let description = item.description || item.content || '';
            const link = item.link || '#';
            const date = new Date(item.pubDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Clean description for search/display (remove HTML/CDATA)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = description;
            let cleanDescription = tempDiv.textContent || tempDiv.innerText || '';
            cleanDescription = cleanDescription.replace(/(\r\n|\n|\r)/gm, " ").substring(0, 150) + (cleanDescription.length > 150 ? '...' : '');

            let isAuto = isAutoFiltered(title, cleanDescription);
            if (isAuto) {
                card.classList.add('auto-filtered');
            }

            // Set data attributes for search
            card.setAttribute('data-search-title', title.toLowerCase());
            card.setAttribute('data-search-desc', cleanDescription.toLowerCase());

            // Build card HTML
            card.innerHTML = `
                <div class="card-controls grid-controls">
                    <span>${sourceName}</span>
                    <button onclick="hideTileForever(this, '${link}')">Hide Forever</button>
                </div>
                <h4><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></h4>
                <p class="description">${cleanDescription}</p>
                <div class="date-and-controls">
                    <span class="date">${date}</span>
                    <div class="card-controls list-controls">
                         <span>${sourceName}</span>
                         <button onclick="hideTileForever(this, '${link}')">Hide Forever</button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemePreference();
            loadViewPreference();
            loadFilterBarPreference();
            loadHiddenLinks();

            // Fetch RSS feeds and load cached AI summary in parallel
            fetchAndRenderAllFeeds();
            loadCachedSummary(); // Auto-display cached summary on page load
        });
    </script>
</body>
</html>
